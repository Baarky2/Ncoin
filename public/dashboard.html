<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Dashboard</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <div class="qr-section">
      <img id="qrImage" alt="QRコード">
      <h2>あなたのQRコード</h2>
    </div>

    <div class="main-content">
      <div class="content">
        <h1 id="welcome">ダッシュボード</h1>
        <p>ここにメイン情報やボタンなどを配置します。</p>
      </div>

      <div class="ranking">
        <h2>ランキング</h2>
        <ul id="rankingList">
          <li>1位: Alice - 1200pt</li>
          <li>2位: Bob - 950pt</li>
          <li>3位: Carol - 820pt</li>
        </ul>
      </div>
    </div>
  </div>

  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <script>
    window.addEventListener("load", async () => {
      const socket = io();
      const nickname = localStorage.getItem("nickname");
      if (!nickname) {
        alert("ログイン情報がありません");
        location.href = "/login.html";
        return;
      }

      document.getElementById("welcome").textContent = `ようこそ ${nickname} さん`;

      const rankingEl = document.getElementById("rankingList");

      // ✅ QRコード生成
      try {
        const qrUrl = `${location.origin}/pay.html?from=${encodeURIComponent(nickname)}`;
        const qrDataUrl = await QRCode.toDataURL(qrUrl);
        document.getElementById("qrImage").src = qrDataUrl;
      } catch (e) {
        console.error("QRコード生成に失敗しました:", e);
      }

      // --- ランキング取得 ---
      async function fetchRanking() {
        const res = await fetch("/ranking");
        const ranking = await res.json();
        rankingEl.innerHTML = "";
        ranking.forEach(u => {
          const li = document.createElement("li");
          li.textContent = `${u.nickname}: ${u.balance} コイン`;
          rankingEl.appendChild(li);
        });
      }

      fetchRanking();
      socket.on("update", fetchRanking);
    });
  </script>
</body>
</html>
