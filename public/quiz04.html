<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NAZOTOKI RALLY Q4</title>
  <style>
    body {
      font-family: "Hiragino Kaku Gothic ProN", sans-serif;
      text-align: center;
      background: #f8f9fa;
      color: #333;
      padding: 20px;
    }
    img {
      width: 90%;
      max-width: 600px;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    input {
      padding: 8px;
      margin-top: 12px;
      border-radius: 6px;
      border: 1px solid #ccc;
      width: 200px;
    }
    button {
      margin-top: 12px;
      padding: 8px 16px;
      border: none;
      background: #007bff;
      color: #fff;
      border-radius: 6px;
      cursor: pointer;
    }
    button:hover { background: #0056b3; }
    #puzzleClearBtn { background: #28a745; display: none; }
    #puzzleClearBtn:hover { background: #218838; }
  </style>
</head>
<body>
  <h1>NAZOTOKI RALLY Q4</h1>
  <img src="/quiz04.png" alt="å•é¡Œç”»åƒ" />
  
  <div>
    <p>è§£ç­”ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼š</p>
    <input type="text" id="answerInput" placeholder="ç­”ãˆã‚’å…¥åŠ›" />
    <button id="checkAnswerBtn">è§£ç­”ã™ã‚‹</button>
  </div>

  <div id="resultMsg" style="margin-top:10px;font-weight:bold;"></div>
  <button id="puzzleClearBtn">è¬ã‚’ã‚¯ãƒªã‚¢ï¼30ã‚³ã‚¤ãƒ³ç²å¾—</button>

  <script>
    // âœ… è¨­å®š
    const correctAnswer = ["èŠ±ç«", "ã¯ãªã³","ã¯ãªç«"]; // æ­£è§£
    const questId = "quiz04";
    const rewardAmount = 30;
    const allQuests = ["quiz01", "quiz02", "quiz03", "quiz04", "quiz05"]; // å…¨å•ãƒªã‚¹ãƒˆ

    // ãƒ­ã‚°ã‚¤ãƒ³ç¢ºèª
    const nickname = localStorage.getItem("nickname");
    if (!nickname) {
      alert("âš ï¸ ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ãƒˆãƒƒãƒ—ã‹ã‚‰ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚");
      location.href = "/index.html";
    }

    const resultMsg = document.getElementById("resultMsg");
    const checkBtn = document.getElementById("checkAnswerBtn");
    const clearBtn = document.getElementById("puzzleClearBtn");
    const answerInput = document.getElementById("answerInput");

    // âœ… ã‚µãƒ¼ãƒãƒ¼ã«å•ã„åˆã‚ã›ã¦ã‚¯ãƒªã‚¢æ¸ˆã¿ã‹ç¢ºèª
    async function checkCleared() {
      try {
        const res = await fetch(`/history/${nickname}`);
        const history = await res.json();
        const cleared = history.some(h => h.questId === questId);
        if (cleared) {
          resultMsg.textContent = "ã“ã®è¬ã¯ã™ã§ã«ã‚¯ãƒªã‚¢æ¸ˆã¿ã§ã™ âœ…";
          resultMsg.style.color = "gray";
          checkBtn.disabled = true;
          answerInput.disabled = true;
        }
      } catch (err) {
        console.error(err);
      }
    }

    checkCleared();

    // âœ… è§£ç­”ãƒœã‚¿ãƒ³
    checkBtn.addEventListener("click", () => {
      const ans = answerInput.value.trim();
      if (!ans) {
        resultMsg.textContent = "è§£ç­”ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚";
        resultMsg.style.color = "gray";
        return;
      }

      if (correctAnswer.includes(ans)) {
        resultMsg.textContent = "æ­£è§£ã§ã™ï¼ğŸ‰";
        resultMsg.style.color = "green";
        clearBtn.style.display = "inline-block";
      } else {
        resultMsg.textContent = "ä¸æ­£è§£ã§ã™ã€‚ã‚‚ã†ä¸€åº¦è€ƒãˆã¦ã¿ã¾ã—ã‚‡ã†ã€‚";
        resultMsg.style.color = "red";
      }
    });

    // âœ… è¬ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³
    clearBtn.addEventListener("click", async () => {
      try {
        // ğŸ”¹ ã“ã®å•é¡Œã®ã‚³ã‚¤ãƒ³ä»˜ä¸
        const res = await fetch("/quest", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ nickname, amount: rewardAmount, type: "è¬è§£ã", questId })
        });
        const data = await res.json();
        if (data.error) {
          alert("ã‚³ã‚¤ãƒ³ä»˜ä¸ã«å¤±æ•—: " + data.error);
          return;
        }

        alert(`è¬è§£ãã‚¯ãƒªã‚¢ï¼${rewardAmount}ã‚³ã‚¤ãƒ³ç²å¾—ã—ã¾ã—ãŸâœ¨`);

        // ğŸ”¹ å…¨å•ã‚¯ãƒªã‚¢ç¢ºèª
        const histRes = await fetch(`/history/${nickname}`);
        const history = await histRes.json();
        const clearedIds = history.map(h => h.questId);
        const allCleared = allQuests.every(q => clearedIds.includes(q));

        // ğŸ”¹ ã™ã§ã«ãƒœãƒ¼ãƒŠã‚¹ã‚’ã‚‚ã‚‰ã£ã¦ã„ãªã„å ´åˆã®ã¿ä»˜ä¸
        const alreadyGotBonus = history.some(h => h.questId === "bonus_all_clear");
if (data.exUnlocked) {
  alert("ğŸ‰ EXå•é¡Œå‡ºç¾ï¼");
}

        if (allCleared && !alreadyGotBonus) {
          const bonusRes = await fetch("/quest", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ nickname, amount: 50, type: "å…¨å•ã‚¯ãƒªã‚¢ãƒœãƒ¼ãƒŠã‚¹", questId: "bonus_all_clear" })
          });
          const bonusData = await bonusRes.json();
          if (!bonusData.error) {
            alert("ğŸŠ å…¨å•ã‚¯ãƒªã‚¢ãƒœãƒ¼ãƒŠã‚¹é”æˆï¼50ã‚³ã‚¤ãƒ³ç²å¾—ã—ã¾ã—ãŸï¼ ğŸ‰");
          }
        }

        // ğŸ”¹ ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã¸
        location.href = "/dashboard";
      } catch (err) {
        alert("ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼: " + err);
      }
    });
  </script>
    <!-- â† ã‚¯ã‚¤ã‚ºä¸€è¦§ã«æˆ»ã‚‹ãƒœã‚¿ãƒ³ -->
<button id="backToListBtn">â† ã‚¯ã‚¤ã‚ºä¸€è¦§ã«æˆ»ã‚‹</button>

<style>
  #backToListBtn {
    position: fixed;
    bottom: 20px;
    left: 20px;
    background: #6c757d;
    color: white;
    border: none;
    border-radius: 6px;
    padding: 10px 16px;
    font-size: 14px;
    cursor: pointer;
    z-index: 1000;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    transition: background 0.2s ease;
  }

  #backToListBtn:hover {
    background: #5a6268;
  }
</style>

<script>
  document.getElementById("backToListBtn").addEventListener("click", () => {
    location.href = "/quiz_list.html";
  });
</script>

</body>
</html>
