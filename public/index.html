<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ログイン</title>
  <link rel="stylesheet" href="style.css">
</head>

<body>
  <div class="login-container">
    <h1>ログイン</h1>

    <input type="text" id="nickname" placeholder="ニックネーム" />

    <!-- 管理者切り替え -->
    <div style="margin-top:10px;">
      <span id="adminToggle">管理者の方は</span>
    </div>

    <!-- 管理者コード欄 -->
    <div id="adminCodeDiv" style="display:none; margin-top:10px;">
      <input type="password" id="adminCode" placeholder="管理者コード" />
    </div>

    <!-- パスワード欄（ユーザー用） -->
    <div id="passwordDiv" style="margin-top:10px;">
      <input type="password" id="password" placeholder="パスワード" />
    </div>

    <div style="margin-top:10px;">
      <button id="loginBtn">ログイン</button>
    </div>
  </div>

<script>
const adminToggle = document.getElementById("adminToggle");
const adminCodeDiv = document.getElementById("adminCodeDiv");
const passwordDiv = document.getElementById("passwordDiv");
const loginBtn = document.getElementById("loginBtn");
const nicknameInput = document.getElementById("nickname");

// 管理者コード欄表示切り替え
adminToggle.addEventListener("click", () => {
  if (adminCodeDiv.style.display === "none") {
    adminCodeDiv.style.display = "block";  // 管理者モードON
    passwordDiv.style.display = "none";    // パスワード不要
    nicknameInput.value = "";
    nicknameInput.disabled = true;         // 管理者はニックネーム固定
  } else {
    adminCodeDiv.style.display = "none";   // 管理者モードOFF
    passwordDiv.style.display = "block";   // パスワード必要
    nicknameInput.disabled = false;
  }
});

loginBtn.addEventListener("click", async () => {
  let nickname = nicknameInput.value.trim();
  const adminCode = adminCodeDiv.style.display === "block"
    ? document.getElementById("adminCode").value
    : "";

const passwordInput = document.getElementById("password");
const password = passwordInput ? passwordInput.value.trim() : "";

  // 管理者なら nickname を固定
  if (adminCode) nickname = "admin";

  if (!nickname) return alert("ニックネームを入力してください");

  // 管理者以外はパスワード必須
  if (!adminCode && !password) {
    return alert("パスワードを入力してください");
  }

  try {
    // 既存ユーザー確認（管理者以外）
    if (!adminCode) {
      const resCheck = await fetch(`/user-exists/${encodeURIComponent(nickname)}`);
      const { exists } = await resCheck.json();

      if (!exists) {
        const ok = confirm("ユーザーが存在しません。新規登録しますか？");
        if (!ok) return;
      }
    }

    // ログイン or 新規登録
    const res = await fetch("/login", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ nickname, password, adminCode })
    });
    const data = await res.json();

    if (data.error) return alert(data.error);

    localStorage.setItem("nickname", data.nickname);
    localStorage.setItem("isAdmin", data.isAdmin);

    location.href = "/dashboard";
  } catch (e) {
    alert("ログインエラー: " + e.message);
  }
});
</script>
</body>
</html>
