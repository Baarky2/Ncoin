<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NAZOTOKI RALLY Q1</title>
  <style>
    body {
      font-family: "Hiragino Kaku Gothic ProN", sans-serif;
      text-align: center;
      background: #f8f9fa;
      color: #333;
      padding: 20px;
    }
    img {
      width: 90%;
      max-width: 600px;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    input {
      padding: 8px;
      margin-top: 12px;
      border-radius: 6px;
      border: 1px solid #ccc;
      width: 200px;
    }
    button {
      margin-top: 12px;
      padding: 8px 16px;
      border: none;
      background: #007bff;
      color: #fff;
      border-radius: 6px;
      cursor: pointer;
    }
    button:hover { background: #0056b3; }
    #puzzleClearBtn { background: #28a745; display: none; }
    #puzzleClearBtn:hover { background: #218838; }
  </style>
</head>
<body>
  <h1>NAZOTOKI RALLY Q1</h1>
  <img src="/quiz01.png" alt="ÂïèÈ°åÁîªÂÉè" />
  
  <div>
    <p>Ëß£Á≠î„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö</p>
    <input type="text" id="answerInput" placeholder="Á≠î„Åà„ÇíÂÖ•Âäõ" />
    <button id="checkAnswerBtn">Ëß£Á≠î„Åô„Çã</button>
  </div>

  <div id="resultMsg" style="margin-top:10px;font-weight:bold;"></div>
  <button id="puzzleClearBtn">Ë¨é„Çí„ÇØ„É™„Ç¢ÔºÅ100„Ç≥„Ç§„É≥Áç≤Âæó</button>

  <script>
    // ‚úÖ Ë®≠ÂÆö
    const correctAnswer = "„Éï„É´„Éº„ÉÑ"; // Ê≠£Ëß£
    const questId = "quiz01";
    const rewardAmount = 100;

    // „É≠„Ç∞„Ç§„É≥Á¢∫Ë™ç
    const nickname = localStorage.getItem("nickname");
    if (!nickname) {
      alert("‚ö†Ô∏è „É≠„Ç∞„Ç§„É≥ÊÉÖÂ†±„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ„Éà„ÉÉ„Éó„Åã„Çâ„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
      location.href = "/login.html";
    }

    const resultMsg = document.getElementById("resultMsg");
    const checkBtn = document.getElementById("checkAnswerBtn");
    const clearBtn = document.getElementById("puzzleClearBtn");
    const answerInput = document.getElementById("answerInput");

    // „Çµ„Éº„Éê„Éº„Å´Âïè„ÅÑÂêà„Çè„Åõ„Å¶„ÇØ„É™„Ç¢Ê∏à„Åø„ÅãÁ¢∫Ë™ç
    async function checkCleared() {
      try {
        const res = await fetch(`/history/${nickname}`);
        const history = await res.json();
        const cleared = history.some(h => h.questId === questId);
        if (cleared) {
          resultMsg.textContent = "„Åì„ÅÆË¨é„ÅØ„Åô„Åß„Å´„ÇØ„É™„Ç¢Ê∏à„Åø„Åß„Åô ‚úÖ";
          resultMsg.style.color = "gray";
          checkBtn.disabled = true;
          answerInput.disabled = true;
        }
      } catch (err) {
        console.error(err);
      }
    }

    checkCleared();

    // Ëß£Á≠î„Éú„Çø„É≥
    checkBtn.addEventListener("click", () => {
      const ans = answerInput.value.trim();
      if (!ans) {
        resultMsg.textContent = "Ëß£Á≠î„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ";
        resultMsg.style.color = "gray";
        return;
      }

      if (ans === correctAnswer) {
        resultMsg.textContent = "Ê≠£Ëß£„Åß„ÅôÔºÅüéâ";
        resultMsg.style.color = "green";
        clearBtn.style.display = "inline-block";
      } else {
        resultMsg.textContent = "‰∏çÊ≠£Ëß£„Åß„Åô„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂ∫¶ËÄÉ„Åà„Å¶„Åø„Åæ„Åó„Çá„ÅÜ„ÄÇ";
        resultMsg.style.color = "red";
      }
    });

    // Ë¨é„ÇØ„É™„Ç¢„Éú„Çø„É≥
    clearBtn.addEventListener("click", async () => {
      try {
        const res = await fetch("/quest", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ nickname, amount: rewardAmount, type: "Ë¨éËß£„Åç", questId })
        });
        const data = await res.json();
        if (data.error) {
          alert("„Ç≥„Ç§„É≥‰ªò‰∏é„Å´Â§±Êïó: " + data.error);
        } else {
          alert(`Ë¨éËß£„Åç„ÇØ„É™„Ç¢ÔºÅ${rewardAmount}„Ç≥„Ç§„É≥Áç≤Âæó„Åó„Åæ„Åó„Åü‚ú®`);
          location.href = "/dashboard";
        }
      } catch (err) {
        alert("„Çµ„Éº„Éê„Éº„Ç®„É©„Éº: " + err);
      }
    });
  </script>
</body>
</html>
