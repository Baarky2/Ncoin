<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>クイズ一覧</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body {
      font-family: "Hiragino Kaku Gothic ProN", sans-serif;
      background: #f8f9fa;
      text-align: center;
      padding: 30px;
      color: #333;
      min-height: 100vh;
    }

    h1 {
      margin-bottom: 20px;
    }

    .quiz-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
      align-items: center;
    }

    button.quizBtn {
      width: 400px;
      padding: 10px;
      border: none;
      border-radius: 8px;
      background: #28a745; /* 緑＝選択可能 */
      color: white;
      font-size: 16px;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    button.quizBtn:hover {
      background: #218838;
    }

    button.cleared {
      background: #ccc !important; /* 灰色＝クリア済み */
      color: #666;
      cursor: default;
    }

    button.cleared:hover {
      background: #ccc;
    }

    /* 左下固定ボタン */
    #backToDashboardBtn {
      position: fixed;
      bottom: 20px;
      left: 20px;
      background: #6c757d;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 10px 16px;
      font-size: 14px;
      cursor: pointer;
      z-index: 1000;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      transition: background 0.2s ease;
    }

    #backToDashboardBtn:hover {
      background: #5a6268;
    }
  </style>
</head>

<body>
  <div class="container">
<div class="quiz-list" id="normalQuizzes">
  <h2>ノーマルクイズ</h2>
  <button class="quizBtn" data-id="quiz01">Quiz01</button>
  <button class="quizBtn" data-id="quiz02">Quiz02</button>
  <button class="quizBtn" data-id="quiz03">Quiz03</button>
  <button class="quizBtn" data-id="quiz04">Quiz04</button>
  <button class="quizBtn" data-id="quiz05">Quiz05</button>
</div>

<div class="quiz-list" id="exQuizzes" style="display:none;">
  <h2>EXクイズ</h2>
<button class="exQuizBtn" data-id="ex01">EX01</button>
<button class="exQuizBtn" data-id="ex02">EX02</button>
<button class="exQuizBtn" data-id="ex03">EX03</button>
<button class="exQuizBtn" data-id="ex04">EX04</button>
<button class="exQuizBtn" data-id="ex05">EX05</button>
<button class="exQuizBtn" data-id="ex06">EX06</button>
<button class="exQuizBtn" data-id="ex07">EX07</button>

</div>


  </div>

  <!-- 左下固定：ダッシュボードに戻る -->
  <button id="backToDashboardBtn">← ダッシュボードに戻る</button>

  <script>
    // ログイン確認
    const nickname = localStorage.getItem("nickname");
    if (!nickname) {
      alert("⚠️ ログイン情報がありません。トップからログインしてください。");
      location.href = "/index.html";
    }

    // クイズ遷移関数
function goQuiz(id) {
  const nickname = localStorage.getItem("nickname");
  if (!nickname) return location.href = "/index.html";

  const btn = document.querySelector(`button[data-id="${id}"]`);
  if (btn.disabled) return alert("回答権がありません");

  // id に応じて HTML を分ける
let page = "";
if (id.startsWith("quiz")) {
  page = `${id}.html`;
} else if (id.startsWith("ex")) {
  // id="ex01" → EX_quiz01.html に飛ばす
  page = `EX_quiz${id.slice(2)}.html`;
}


  window.location.href = `${page}?nickname=${encodeURIComponent(nickname)}`;
}



    // 左下ボタン
    document.getElementById("backToDashboardBtn").addEventListener("click", () => {
      location.href = "/dashboard";
    });


// ノーマルクイズ
document.querySelectorAll(".quizBtn").forEach(btn => {
  btn.addEventListener("click", () => goQuiz(btn.dataset.id));
});
// EXクイズ
document.querySelectorAll(".exQuizBtn").forEach(btn => {
  btn.addEventListener("click", () => goQuiz(btn.dataset.id));
});

    // クリア済みクイズを灰色化
    async function loadClearedQuizzes() {
      try {
        const res = await fetch(`/history/${encodeURIComponent(nickname)}`);
        const history = await res.json();
        const clearedIds = history.map(h => h.questId).filter(id => id && id.startsWith("quiz"));

        clearedIds.forEach(id => {
          const btn = document.querySelector(`button[data-id="${id}"]`);
          if (btn) {
            btn.classList.add("cleared");
            btn.textContent += " ✅";
            btn.disabled = true;
          }
        });
      } catch (err) {
        console.error("履歴取得エラー:", err);
      }
    }

    // 回答権のないクイズを灰色・未開放化
async function loadQuizRights() {
  try {
    const res = await fetch(`/quiz-rights/${encodeURIComponent(nickname)}`);
    const { quizRights, exQuizRights } = await res.json();

    // ノーマルクイズ
document.querySelectorAll(".quizBtn").forEach(btn => {
  const quizId = btn.dataset.id;
  if (!quizRights[quizId]) {
    btn.disabled = true;
    btn.classList.add("locked");  // 灰色表示
    btn.classList.remove("available", "cleared");
  }
});

    // EXクイズ
    document.querySelectorAll(".exQuizBtn").forEach(btn => {
      const quizId = btn.dataset.id;
      if (!exQuizRights || !exQuizRights[quizId]) {
        btn.disabled = true;
        btn.style.backgroundColor = "#ccc";
        btn.style.color = "#666";
        const label = document.createElement("span");
        label.textContent = " (未開放)";
        label.style.color = "red";
        btn.appendChild(label);
      }
    });

  } catch (err) {
    console.error("回答権取得エラー:", err);
  }
}

// EX問題解放チェック
async function checkExUnlocked() {
  try {
    // ユーザー履歴を取得
  const historyRes = await fetch(`/history/${encodeURIComponent(nickname)}`);
  const history = await historyRes.json();
  const clearedIds = history.map(h => h.questId || "").filter(id => id.startsWith("quiz"));
  const normalQuizIds = Array.from(document.querySelectorAll(".quizBtn")).map(b => b.dataset.id);
  const allCleared = normalQuizIds.every(id => clearedIds.includes(id));

  document.getElementById("exQuizzes").style.display = allCleared ? "block" : "none";

    if (allCleared) {
      document.getElementById("exQuizzes").style.display = "block";
    } else {
      document.getElementById("exQuizzes").style.display = "none";
    }
  } catch (err) {
    console.error("EXチェックエラー:", err);
  }
}

async function loadQuizButtons() {
  try {
    const historyRes = await fetch(`/history/${encodeURIComponent(nickname)}`);
    const history = await historyRes.json();
    const clearedIds = history.map(h => h.questId).filter(id => id && id.startsWith("quiz"));

    const rightsRes = await fetch(`/quiz-rights/${encodeURIComponent(nickname)}`);
    const { quizRights, exQuizRights } = await rightsRes.json();

// ノーマルクイズ
document.querySelectorAll(".quizBtn").forEach(btn => {
  const quizId = btn.dataset.id;
  btn.classList.remove("locked", "available", "cleared");

  if (clearedIds.includes(quizId)) {
    // ✅ 正解済み
    btn.classList.add("cleared");
    btn.textContent = quizId.toUpperCase() + " ✅";
    btn.disabled = true;
  } else if (quizRights[quizId]) {
    // 回答権あり
    btn.classList.add("available");
    btn.disabled = false;
    btn.textContent = quizId.toUpperCase();
  } else {
    // 未解放
    btn.classList.add("locked");
    btn.disabled = true;
    btn.textContent = quizId.toUpperCase();
  }
});

// EXクイズも同様
document.querySelectorAll(".exQuizBtn").forEach(btn => {
  const quizId = btn.dataset.id;
  btn.classList.remove("locked", "available", "cleared");

  if (clearedIds.includes(quizId)) {
    btn.classList.add("cleared"); // ✅ 正解済み
    btn.textContent = quizId.toUpperCase() + " ✅";
    btn.disabled = true;
  } else if (exQuizRights && exQuizRights[quizId]) {
    btn.classList.add("available"); // 回答権あり
    btn.disabled = false;
    btn.textContent = quizId.toUpperCase();
  } else {
    btn.classList.add("locked"); // 未開放
    btn.disabled = true;
    btn.textContent = quizId.toUpperCase();
  }
});


    // EXクイズ表示
    const anyExAvailable = Object.values(exQuizRights || {}).some(v => v);
    document.getElementById("exQuizzes").style.display = anyExAvailable ? "block" : "none";

  } catch (err) {
    console.error("回答権取得エラー:", err);
  }
}


// 初期化
loadQuizButtons();

checkExUnlocked();

    // 初期化
    loadClearedQuizzes();
    loadQuizRights();

  </script>
</body>
</html>
