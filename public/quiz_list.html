<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>クイズ一覧</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body {
      font-family: "Hiragino Kaku Gothic ProN", sans-serif;
      background: #f8f9fa;
      text-align: center;
      padding: 30px;
      color: #333;
      min-height: 100vh;
    }

    h1 {
      margin-bottom: 20px;
    }

    .quiz-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
      align-items: center;
    }

    button.quizBtn {
      width: 400px;
      padding: 10px;
      border: none;
      border-radius: 8px;
      background: #28a745; /* 緑＝選択可能 */
      color: white;
      font-size: 16px;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    button.quizBtn:hover {
      background: #218838;
    }

    button.cleared {
  background-color: #28a745 !important; /* 緑＝クリア済み */
  color: white;
  cursor: default;
    }

    button.cleared:hover {
  background-color: #218838; /* ホバー時の濃緑 */

    }

    /* 左下固定ボタン */
    #backToDashboardBtn {
      position: fixed;
      bottom: 20px;
      left: 20px;
      background: #6c757d;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 10px 16px;
      font-size: 14px;
      cursor: pointer;
      z-index: 1000;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      transition: background 0.2s ease;
    }

    #backToDashboardBtn:hover {
      background: #5a6268;
    }
  </style>
</head>

<body>
  <div class="container">
<div class="quiz-list" id="normalQuizzes">
  <h2>ノーマルクイズ</h2>
  <button class="quizBtn" data-id="quiz01">Quiz01</button>
  <button class="quizBtn" data-id="quiz02">Quiz02</button>
  <button class="quizBtn" data-id="quiz03">Quiz03</button>
  <button class="quizBtn" data-id="quiz04">Quiz04</button>
  <button class="quizBtn" data-id="quiz05">Quiz05</button>
</div>

<div class="quiz-list" id="exQuizzes" style="display:none;">
  <h2>EXクイズ</h2>
<button class="exQuizBtn" data-id="ex01">EX01</button>
<button class="exQuizBtn" data-id="ex02">EX02</button>
<button class="exQuizBtn" data-id="ex03">EX03</button>
<button class="exQuizBtn" data-id="ex04">EX04</button>
<button class="exQuizBtn" data-id="ex05">EX05</button>
<button class="exQuizBtn" data-id="ex06">EX06</button>
<button class="exQuizBtn" data-id="ex07">EX07</button>

</div>


  </div>

  <!-- 左下固定：ダッシュボードに戻る -->
  <button id="backToDashboardBtn">← ダッシュボードに戻る</button>

  <script>
    // ログイン確認
    const nickname = localStorage.getItem("nickname");
    if (!nickname) {
      alert("⚠️ ログイン情報がありません。トップからログインしてください。");
      location.href = "/index.html";
    }
// クイズクリア時の処理
function markCleared(quizId) {
  const btn = document.querySelector(`.quizBtn[data-id="${quizId}"], .exQuizBtn[data-id="${quizId}"]`);
  if (btn) {
    btn.classList.remove("available", "locked");
    btn.classList.add("cleared");
    btn.disabled = true; // クリック不可にする場合
  }



  // EXクイズ
  const exBtn = document.querySelector(`.exQuizBtn[data-id="${quizId}"]`);
  if (exBtn) {
    exBtn.classList.remove("available", "locked");
    exBtn.classList.add("cleared");
    exBtn.disabled = true;
  }
}

    // クイズ遷移関数
function goQuiz(id) {
  const nickname = localStorage.getItem("nickname");
  if (!nickname) return location.href = "/index.html";

  const btn = document.querySelector(`button[data-id="${id}"]`);
  if (btn.disabled) return alert("回答権がありません");

  // id に応じて HTML を分ける
let page = "";
if (id.startsWith("quiz")) {
  page = `${id}.html`;
} else if (id.startsWith("ex")) {
  // id="ex01" → EX_quiz01.html に飛ばす
  page = `EX_quiz${id.slice(2)}.html`;
}


  window.location.href = `${page}?nickname=${encodeURIComponent(nickname)}`;
}



    // 左下ボタン
    document.getElementById("backToDashboardBtn").addEventListener("click", () => {
      location.href = "/dashboard";
    });


// ノーマルクイズ
document.querySelectorAll(".quizBtn").forEach(btn => {
  btn.addEventListener("click", () => goQuiz(btn.dataset.id));
});
// EXクイズ
document.querySelectorAll(".exQuizBtn").forEach(btn => {
  btn.addEventListener("click", () => goQuiz(btn.dataset.id));
});

    // クリア済みクイズを灰色化
    async function loadClearedQuizzes() {
      try {
        const res = await fetch(`/history/${encodeURIComponent(nickname)}`);
        const history = await res.json();
        const clearedIds = history.map(h => h.questId).filter(id => id && id.startsWith("quiz"));

        clearedIds.forEach(id => {
          const btn = document.querySelector(`button[data-id="${id}"]`);
          if (btn) {
            btn.classList.add("cleared");
            btn.textContent;
            btn.disabled = true;
          }
        });
      } catch (err) {
        console.error("履歴取得エラー:", err);
      }
    }

    // 回答権のないクイズを灰色・未開放化
async function loadQuizRights() {
  try {
    const res = await fetch(`/quiz-rights/${encodeURIComponent(nickname)}`);
    const { quizRights, exQuizRights } = await res.json();

    // ノーマルクイズ
document.querySelectorAll(".quizBtn").forEach(btn => {
  const quizId = btn.dataset.id;
  if (!quizRights[quizId]) {
    btn.disabled = true;
    btn.classList.add("locked");  // 灰色表示
    btn.classList.remove("available", "cleared");
  }
});

    // EXクイズ
    document.querySelectorAll(".exQuizBtn").forEach(btn => {
      const quizId = btn.dataset.id;
      if (!exQuizRights || !exQuizRights[quizId]) {
        btn.disabled = true;
        btn.style.backgroundColor = "#ccc";
        btn.style.color = "#666";
        const label = document.createElement("span");
        label.textContent = " (未開放)";
        label.style.color = "red";
        btn.appendChild(label);
      }
    });

  } catch (err) {
    console.error("回答権取得エラー:", err);
  }
}

// EX問題解放チェック
async function checkExUnlocked() {
  try {
    // ユーザー履歴を取得
  const historyRes = await fetch(`/history/${encodeURIComponent(nickname)}`);
  const history = await historyRes.json();
  const clearedIds = history.map(h => h.questId || "").filter(id => id.startsWith("quiz"));
  const normalQuizIds = Array.from(document.querySelectorAll(".quizBtn")).map(b => b.dataset.id);
  const allCleared = normalQuizIds.every(id => clearedIds.includes(id));

  document.getElementById("exQuizzes").style.display = allCleared ? "block" : "none";

    if (allCleared) {
      document.getElementById("exQuizzes").style.display = "block";
    } else {
      document.getElementById("exQuizzes").style.display = "none";
    }
  } catch (err) {
    console.error("EXチェックエラー:", err);
  }
}

async function loadQuizButtons() {
  try {
    const historyRes = await fetch(`/history/${encodeURIComponent(nickname)}`);
    const history = await historyRes.json();
    const clearedIds = history.map(h => h.questId).filter(id => id && id.startsWith("quiz"));

    const rightsRes = await fetch(`/quiz-rights/${encodeURIComponent(nickname)}`);
    const { quizRights, exQuizRights } = await rightsRes.json();

// ノーマルクイズ
document.querySelectorAll(".quizBtn").forEach(btn => {
  const quizId = btn.dataset.id;
  btn.classList.remove("locked", "available", "cleared");

  if (clearedIds.includes(quizId)) {
    // ✅ 正解済み → 緑＋報酬受け取り済みに変更
    btn.classList.add("cleared");
    btn.textContent = "報酬受け取り済み";
    btn.disabled = true;
  } else if (quizRights[quizId]) {
    // 回答権あり
    btn.classList.add("available");
    btn.disabled = false;
    btn.textContent = quizId.toUpperCase();
  } else {
    // 未解放
    btn.classList.add("locked");
    btn.disabled = true;
    btn.textContent = quizId.toUpperCase();
  }
});

// EXクイズも同様
document.querySelectorAll(".exQuizBtn").forEach(btn => {
  const quizId = btn.dataset.id;
  btn.classList.remove("locked", "available", "cleared");

  if (clearedIds.includes(quizId)) {
    btn.classList.add("cleared"); // ✅ 正解済み
    btn.textContent = "報酬受け取り済み";
    btn.disabled = true;
  } else if (exQuizRights && exQuizRights[quizId]) {
    btn.classList.add("available"); // 回答権あり
    btn.disabled = false;
    btn.textContent = quizId.toUpperCase();
  } else {
    btn.classList.add("locked"); // 未開放
    btn.disabled = true;
    btn.textContent = quizId.toUpperCase();
  }
});


    // EXクイズ表示
    const anyExAvailable = Object.values(exQuizRights || {}).some(v => v);
    document.getElementById("exQuizzes").style.display = anyExAvailable ? "block" : "none";

  } catch (err) {
    console.error("回答権取得エラー:", err);
  }
}

// EXクイズ解放 & 表示処理（1つずつ解放）
async function loadExQuizzes() {
  try {
    // 履歴からクリア済みを取得
    const historyRes = await fetch(`/history/${encodeURIComponent(nickname)}`);
    const history = await historyRes.json();
    const clearedIds = history.map(h => h.questId);

    const exContainer = document.getElementById("exQuizzes");
    exContainer.innerHTML = "<h2>EXクイズ</h2>"; // ★初期化（表示を作り直す）

    const exList = ["ex01", "ex02", "ex03", "ex04", "ex05", "ex06", "ex07"];

    let unlocked = true; // EX01 は常に解放扱い（最初は true）

    for (let i = 0; i < exList.length; i++) {
      const id = exList[i];

      // ★ unlocked が false → この EX は表示しない
      if (!unlocked) break;

      // ボタン生成
      const btn = document.createElement("button");
      btn.className = "exQuizBtn";
      btn.dataset.id = id;
      btn.textContent = id.toUpperCase();

      // クリア済みなら緑＋チェック
      if (clearedIds.includes(id)) {
        btn.classList.add("cleared");
        btn.textContent = id.toUpperCase();
        btn.disabled = true;

        // ★ 次の EX の解放許可
        unlocked = true;
      } else {
        // まだ解いていない場合
        btn.classList.add("available");
        btn.disabled = false;

        // ★ 次の EX は解放しない
        unlocked = false;
      }

      btn.addEventListener("click", () => goQuiz(id));
      exContainer.appendChild(btn);
    }

  } catch (err) {
    console.error("EXロードエラー:", err);
  }
}

loadQuizButtons();
checkExUnlocked();
loadClearedQuizzes();
loadQuizRights();
loadExQuizzes();   // ★EXの1問ずつ解放用

  </script>
</body>
</html>
